<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XPR SimplePay – Test Local</title>

  <!-- Proton Web SDK (phiên bản hoạt động với WebAuth) -->
  <script src="https://unpkg.com/@proton/web-sdk@4.0.0/dist/index.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f7f9fc; color: #333; margin: 0; padding: 2rem; }
    h1 { color: #2b70f9; }
    #status { margin-top: 1rem; font-weight: bold; min-height: 20px; color: #d32f2f; }
    #userInfo { margin-top: 1rem; background: #e8f5e9; padding: 1rem; border-radius: 6px; display: none; }
    form { margin-top: 1rem; display: none; }
    input, button { padding: 0.5rem; margin: 0.25rem 0; width: 100%; font-size: 1rem; box-sizing: border-box; }
    button { background: #2b70f9; color: white; border: none; cursor: pointer; border-radius: 4px; }
    button:hover { background: #1f55c2; }
    button:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>XPR SimplePay</h1>
  <p>by UBITQUITY Merchant Solutions</p>

  <button id="connectButton">Connect WebAuth Wallet</button>

  <div id="userInfo"></div>

  <form id="paymentForm">
    <input id="recipient" placeholder="Recipient (e.g. testxpr12345)" required />
    <input id="amount" type="number" step="0.0001" min="0.0001" placeholder="Amount XPR" required />
    <input id="memo" placeholder="Memo (optional)" />
    <button type="submit">Send Payment</button>
  </form>

  <div id="status">Ready.</div>

  <script>
    // === XPR MAINNET - ĐÃ XÁC NHẬN HOẠT ĐỘNG ===
    const CHAIN_ID = "384da888112027f0321850a169f737c33e53b388aad48b5adace4bab97f437e0";
    const ENDPOINTS = ["https://proton.greymass.com"];
    const APP_NAME = "XPRSimplePay";

    let link, session;
    const statusEl = document.getElementById('status');
    const connectButton = document.getElementById('connectButton');
    const paymentForm = document.getElementById('paymentForm');
    const userInfo = document.getElementById('userInfo');

    // Kiểm tra SDK
    if (!window.ProtonWebSDK) {
      statusEl.textContent = "SDK failed to load. Check internet.";
      console.error("ProtonWebSDK not loaded");
    }

    async function connectWallet() {
      connectButton.disabled = true;
      statusEl.textContent = "Opening WebAuth...";

      try {
        const { link: l, session: s } = await ProtonWebSDK({
          linkOptions: { chainId: CHAIN_ID, endpoints: ENDPOINTS, restoreSession: true },
          transportOptions: { requestAccount: APP_NAME },
          selectorOptions: { appName: APP_NAME }
        });

        link = l; session = s;
        const actor = s.auth.actor;

        userInfo.textContent = `Connected: ${actor}`;
        userInfo.style.display = 'block';
        connectButton.style.display = 'none';
        paymentForm.style.display = 'block';
        statusEl.textContent = "Ready to send.";
        statusEl.style.color = "#2e7d32";
      } catch (e) {
        statusEl.textContent = `Connect failed: ${e.message}`;
        statusEl.style.color = "#d32f2f";
        connectButton.disabled = false;
        console.error(e);
      }
    }

    async function sendPayment(e) {
      e.preventDefault();
      if (!session) return;

      const recipient = document.getElementById('recipient').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const memo = document.getElementById('memo').value.trim();

      if (!recipient || isNaN(amount) || amount <= 0) {
        statusEl.textContent = "Invalid input.";
        return;
      }

      const quantity = `${amount.toFixed(4)} XPR`;
      statusEl.textContent = "Confirm in WebAuth...";

      try {
        const result = await session.transact({
          actions: [{
            account: 'eosio.token',
            name: 'transfer',
            authorization: [{ actor: session.auth.actor, permission: session.auth.permission }],
            data: { from: session.auth.actor, to: recipient, quantity, memo }
          }]
        }, { broadcast: true });

        statusEl.innerHTML = `
          <strong style="color:green">Success!</strong><br>
          <a href="https://explorer.xprnetwork.org/transaction/${result.processed.id}" target="_blank">
            View Tx: ${result.processed.id.slice(0, 12)}...
          </a>
        `;
      } catch (e) {
        statusEl.textContent = `Send failed: ${e.message}`;
        console.error(e);
      }
    }

    connectButton.addEventListener('click', connectWallet);
    paymentForm.addEventListener('submit', sendPayment);
  </script>
</body>
</html>
