<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XPR SimplePay – UBITQUITY</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f9fc;
      color: #333;
      margin: 0;
      padding: 2rem;
    }
    h1 {
      color: #2b70f9;
      margin-bottom: 0.5rem;
    }
    p {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #555;
    }
    #status {
      margin-top: 1rem;
      font-weight: bold;
      min-height: 20px;
      color: #d32f2f;
      white-space: pre-wrap;
    }
    #userInfo {
      margin-top: 1rem;
      background: #e8f5e9;
      padding: 1rem;
      border-radius: 6px;
      display: none;
      font-family: monospace;
    }
    form {
      margin-top: 1rem;
      display: none;
    }
    input, button {
      padding: 0.5rem;
      margin: 0.25rem 0;
      width: 100%;
      font-size: 1rem;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      background: #2b70f9;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #1f55c2; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    a.install {
      display:inline-block;
      margin-top:0.5rem;
      color:#2b70f9;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h1>XPR SimplePay</h1>
  <p>by UBITQUITY Merchant Solutions</p>

  <button id="connectButton">Connect WebAuth Wallet</button>
  <a class="install" id="installLink" href="https://protonwallet.com/" target="_blank" style="display:none;">
    Install Proton Wallet / WebAuth-compatible wallet
  </a>

  <div id="userInfo"></div>

  <form id="paymentForm">
    <input id="recipient" placeholder="Recipient (e.g. testxpr12345)" required />
    <input id="amount" type="number" step="0.0001" min="0.0001" placeholder="Amount XPR" required />
    <input id="memo" placeholder="Memo (optional)" />
    <button type="submit">Send Payment</button>
  </form>

  <div id="status">Loading SDK…</div>

  <script>
    // === CONFIGURATION ===
    const CHAIN_ID = "384da888112027f0321850a169f737c33e53b388aad48b5adace4bab97f437e0";
    const ENDPOINTS = [
      "https://proton.greymass.com",
      "https://api.protonnz.com",
      "https://proton.eosusa.io"
    ];
    const APP_NAME = "XPRSimplePay";
    const APP_LOGO = "https://via.placeholder.com/150?text=UBITQUITY";

    let link, session;
    const statusEl = document.getElementById('status');
    const connectButton = document.getElementById('connectButton');
    const paymentForm = document.getElementById('paymentForm');
    const userInfo = document.getElementById('userInfo');
    const installLink = document.getElementById('installLink');

    // === HELPER: load script with fallback ===
    function loadScriptWithFallback(urls, timeout = 10000) {
      return new Promise((resolve, reject) => {
        let tried = 0;
        function tryNext() {
          if (tried >= urls.length) {
            reject(new Error('All script URLs failed'));
            return;
          }
          const url = urls[tried++];
          const script = document.createElement('script');
          script.src = url;
          script.async = true;
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            script.onerror = null;
            script.onload = null;
            script.remove();
            tryNext();
          }, timeout);
          script.onload = () => {
            clearTimeout(timer);
            if (!timedOut) resolve(url);
          };
          script.onerror = () => {
            clearTimeout(timer);
            script.remove();
            tryNext();
          };
          document.head.appendChild(script);
        }
        tryNext();
      });
    }

    // === INIT SDK ===
    async function initSDK() {
      if (window.location.protocol === 'file:') {
        statusEl.textContent = "⚠️ This page is loaded from file:// — Please host via HTTP(S).";
        statusEl.style.color = "#d32f2f";
      } else {
        statusEl.textContent = "Loading Proton Web SDK…";
      }

      const urls = [
        "https://unpkg.com/@proton/web-sdk@latest/dist/index.js",
        "https://cdn.jsdelivr.net/npm/@proton/web-sdk@latest/dist/index.js"
      ];

      try {
        await loadScriptWithFallback(urls, 12000);
        console.log("SDK loaded successfully");
      } catch (err) {
        console.error("SDK load failed:", err);
        statusEl.textContent = "SDK failed to load. Check your internet or CDN access.";
        statusEl.style.color = "#d32f2f";
        return;
      }

      if (!window.ProtonWebSDK) {
        statusEl.textContent = "ProtonWebSDK not found after loading script.";
        statusEl.style.color = "#d32f2f";
        return;
      }

      statusEl.textContent = "✅ SDK loaded. Ready to connect.";
      statusEl.style.color = "#2e7d32";
      installLink.style.display = 'inline-block';
      connectButton.disabled = false;
    }

    initSDK();

    // === CONNECT WALLET ===
    async function connectWallet() {
      connectButton.disabled = true;
      statusEl.textContent = "Opening wallet selector…";
      statusEl.style.color = "#444";

      try {
        const sdkOptions = {
          linkOptions: {
            chainId: CHAIN_ID,
            endpoints: ENDPOINTS,
            restoreSession: false
          },
          transportOptions: { requestAccount: APP_NAME },
          selectorOptions: {
            appName: APP_NAME,
            appLogo: APP_LOGO
          }
        };

        const { link: l, session: s } = await window.ProtonWebSDK(sdkOptions);
        link = l;
        session = s;

        const actor = s.auth.actor;
        userInfo.textContent = `Connected: ${actor} (${s.auth.permission})`;
        userInfo.style.display = 'block';
        connectButton.style.display = 'none';
        paymentForm.style.display = 'block';
        statusEl.textContent = "Ready to send.";
        statusEl.style.color = "#2e7d32";

      } catch (e) {
        console.error("Connect Error:", e);
        const msg = e?.message || e.toString();
        let hint = "";
        if (/no.*wallet/i.test(msg)) {
          hint = "No wallet found. Install WebAuth or Proton Wallet.";
          installLink.style.display = 'inline-block';
        }
        statusEl.textContent = `Connect failed: ${msg}. ${hint}`;
        statusEl.style.color = "#d32f2f";
        connectButton.disabled = false;
      }
    }

    // === SEND PAYMENT ===
    async function sendPayment(e) {
      e.preventDefault();
      if (!session) {
        statusEl.textContent = "Connect wallet first.";
        statusEl.style.color = "#d32f2f";
        return;
      }

      const recipient = document.getElementById('recipient').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const memo = document.getElementById('memo').value.trim();

      if (!recipient || isNaN(amount) || amount <= 0) {
        statusEl.textContent = "Invalid recipient or amount.";
        statusEl.style.color = "#d32f2f";
        return;
      }

      const quantity = `${amount.toFixed(4)} XPR`;
      statusEl.textContent = "Confirm in wallet…";
      statusEl.style.color = "#444";

      try {
        const result = await session.transact({
          actions: [{
            account: "eosio.token",
            name: "transfer",
            authorization: [{
              actor: session.auth.actor,
              permission: session.auth.permission
            }],
            data: { from: session.auth.actor, to: recipient, quantity, memo }
          }]
        }, { broadcast: true });

        console.log("Transaction result:", result);
        const txId = result?.processed?.id || result?.transaction_id || "";
        statusEl.innerHTML = `
          <strong style="color:green">✅ Success!</strong><br>
          <a href="https://explorer.xprnetwork.org/transaction/${txId}" target="_blank">
            View Transaction
          </a>
        `;
      } catch (e) {
        console.error("Send Error:", e);
        statusEl.textContent = `Send failed: ${e.message || e.toString()}`;
        statusEl.style.color = "#d32f2f";
      }
    }

    connectButton.addEventListener('click', connectWallet);
    paymentForm.addEventListener('submit', sendPayment);
  </script>
</body>
</html>
