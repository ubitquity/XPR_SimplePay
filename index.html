<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XPR SimplePay Test ‚Äì UBITQUITY</title>

  <!-- Proton Web SDK (d√πng unpkg ƒë·ªÉ ·ªïn ƒë·ªãnh h∆°n) -->
  <script src="https://unpkg.com/@proton/web-sdk@4.0.0/dist/index.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f7f9fc; color: #333; margin: 0; padding: 2rem; }
    h1 { color: #2b70f9; }
    #status { margin-top: 1rem; font-weight: bold; min-height: 20px; }
    #userInfo { margin-top: 1rem; background: #eaf3ff; padding: 1rem; border-radius: 6px; display: none; }
    form { margin-top: 1rem; display: none; }
    input, button { padding: 0.5rem; margin: 0.25rem 0; width: 100%; font-size: 1rem; box-sizing: border-box; }
    button { background: #2b70f9; color: white; border: none; cursor: pointer; border-radius: 4px; }
    button:hover { background: #1f55c2; }
    button:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>XPR SimplePay by UBITQUITY Merchant Solutions</h1>
  <p>Connect your wallet to begin.</p>

  <button id="connectButton">üîó Connect Wallet</button>

  <div id="userInfo"></div>

  <form id="paymentForm">
    <input id="recipient" placeholder="Recipient account (e.g. yourmerchantxpr)" required />
    <input id="amount" type="number" step="0.0001" min="0.0001" placeholder="Amount in XPR (e.g. 1.5)" required />
    <input id="memo" placeholder="Memo (optional)" />
    <button type="submit">üöÄ Send Payment</button>
  </form>

  <div id="status"></div>

  <script>
    // === XPR Mainnet Config (ƒë√£ x√°c th·ª±c) ===
    const CHAIN_ID = "384da888112027f0321850a169f737c33e53b388aad48b5adace4bab97f437e0";
    const ENDPOINTS = ["https://proton.greymass.com"];
    const APP_NAME = "XPRSimplePay";

    let link, session;
    const statusEl = document.getElementById('status');
    const connectButton = document.getElementById('connectButton');
    const paymentForm = document.getElementById('paymentForm');
    const userInfo = document.getElementById('userInfo');

    // Ki·ªÉm tra SDK load
    if (typeof ProtonWebSDK === 'undefined') {
      statusEl.textContent = '‚ùå Proton SDK failed to load. Check network or CDN.';
      console.error('SDK not loaded');
    }

    // --- Connect Wallet ---
    async function connectWallet() {
      if (!ProtonWebSDK) return statusEl.textContent = '‚ùå SDK not ready. Reload page.';
      
      connectButton.disabled = true;
      statusEl.textContent = "Connecting to wallet...";

      try {
        const { link: walletLink, session: walletSession } = await ProtonWebSDK({
          linkOptions: {
            chainId: CHAIN_ID,
            endpoints: ENDPOINTS,
            restoreSession: true
          },
          transportOptions: { requestAccount: APP_NAME },
          selectorOptions: { appName: APP_NAME }
        });

        link = walletLink;
        session = walletSession;

        const actor = session.auth.actor;
        userInfo.textContent = `‚úÖ Wallet Connected: ${actor}`;
        userInfo.style.display = 'block';
        connectButton.style.display = 'none';
        paymentForm.style.display = 'block';
        statusEl.textContent = 'Ready to send a transaction.';
        console.log('Connected:', actor);
      } catch (e) {
        statusEl.textContent = `‚ùå Connect failed: ${e.message || e}`;
        console.error("Connect Error:", e);
        connectButton.disabled = false;
      }
    }

    // --- Send Payment ---
    async function sendPayment(event) {
      event.preventDefault();
      if (!session) return statusEl.textContent = '‚ö†Ô∏è Connect wallet first.';

      const recipient = document.getElementById('recipient').value.trim();
      const amountStr = document.getElementById('amount').value.trim();
      const memo = document.getElementById('memo').value.trim();

      const amount = parseFloat(amountStr);
      if (!recipient || isNaN(amount) || amount <= 0) {
        return statusEl.textContent = '‚ö†Ô∏è Invalid recipient or amount.';
      }

      const quantity = `${amount.toFixed(4)} XPR`;

      statusEl.textContent = 'üöÄ Sending... Confirm in wallet.';
      try {
        const { actor, permission } = session.auth;
        const actions = [{
          account: 'eosio.token',
          name: 'transfer',
          authorization: [{ actor, permission }],
          data: { from: actor, to: recipient, quantity, memo: memo || '' }
        }];

        const result = await session.transact({ actions }, { broadcast: true });
        statusEl.innerHTML = `
          <strong>‚úÖ Success!</strong><br>
          Tx ID: ${result.processed.id}<br>
          <a href="https://explorer.xprnetwork.org/transaction/${result.processed.id}" target="_blank">View on Explorer</a>
        `;
        console.log('Tx success:', result);
      } catch (e) {
        statusEl.textContent = `‚ùå Send failed: ${e.message || e}`;
        console.error("Send Error:", e);
      }
    }

    connectButton.addEventListener('click', connectWallet);
    paymentForm.addEventListener('submit', sendPayment);
  </script>
</body>
</html>
