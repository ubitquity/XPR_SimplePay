<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XPR SimplePay – UBITQUITY</title>

  <!-- SỬA: Dùng CDN ổn định -->
  <script src="https://cdn.jsdelivr.net/npm/@proton/web-sdk@4.2.0/dist/umd/proton-web-sdk.umd.js"></script>
  <script>
    // Kiểm tra SDK
    setTimeout(() => {
      console.log("SDK version check:", window.ProtonWebSDK ? "Loaded" : "Not loaded");
    }, 1000);
  </script>

  <style>
    body { font-family: Arial, sans-serif; background: #f7f9fc; color: #333; margin: 0; padding: 2rem; }
    h1 { color: #2b70f9; margin-bottom: 0.5rem; }
    p { margin-top: 0; margin-bottom: 1.5rem; color: #555; }
    #status { margin-top: 1rem; font-weight: bold; min-height: 20px; color: #d32f2f; }
    #userInfo { margin-top: 1rem; background: #e8f5e9; padding: 1rem; border-radius: 6px; display: none; font-family: monospace; }
    form { margin-top: 1rem; display: none; }
    input, button { padding: 0.5rem; margin: 0.25rem 0; width: 100%; font-size: 1rem; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #2b70f9; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background: #1f55c2; }
    button:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>XPR SimplePay</h1>
  <p>by UBITQUITY Merchant Solutions</p>

  <button id="connectButton">Connect WebAuth Wallet</button>

  <div id="userInfo"></div>

  <form id="paymentForm">
    <input id="recipient" placeholder="Recipient (e.g. testxpr12345)" required />
    <input id="amount" type="number" step="0.0001" min="0.0001" placeholder="Amount XPR" required />
    <input id="memo" placeholder="Memo (optional)" />
    <button type="submit">Send Payment</button>
  </form>

  <div id="status">Ready.</div>

  <script>
    const CHAIN_ID = "384da888112027f0321850a169f737c33e53b388aad48b5adace4bab97f437e0";
    const ENDPOINTS = ["https://proton.greymass.com", "https://api.protonnz.com", "https://proton.eosusa.io"];
    const APP_NAME = "XPRSimplePay";
    const APP_LOGO = "https://via.placeholder.com/150?text=UBITQUITY";

    let link, session;
    const statusEl = document.getElementById('status');
    const connectButton = document.getElementById('connectButton');
    const paymentForm = document.getElementById('paymentForm');
    const userInfo = document.getElementById('userInfo');

    // Kiểm tra SDK
    if (!window.ProtonWebSDK) {
      statusEl.textContent = "SDK failed to load. Check internet.";
      console.error("ProtonWebSDK not loaded");
    }

    async function connectWallet() {
      connectButton.disabled = true;
      statusEl.textContent = "Opening WebAuth...";

      try {
        // SỬA: Dùng .connect() thay vì gọi như hàm
        const { link: l, session: s } = await window.ProtonWebSDK.connect({
          linkOptions: {
            chainId: CHAIN_ID,
            endpoints: ENDPOINTS,
            restoreSession: true
          },
          transportOptions: {
            requestAccount: APP_NAME
          },
          selectorOptions: {
            appName: APP_NAME,
            appLogo: APP_LOGO,
            enabledWalletTypes: ['webauth']
          }
        });

        link = l;
        session = s;
        const actor = s.auth.actor;

        userInfo.textContent = `Connected: ${actor}`;
        userInfo.style.display = 'block';
        connectButton.style.display = 'none';
        paymentForm.style.display = 'block';
        statusEl.textContent = "Ready to send.";
        statusEl.style.color = "#2e7d32";
      } catch (e) {
        statusEl.textContent = `Connect failed: ${e.message || 'Unknown error'}`;
        statusEl.style.color = "#d32f2f";
        connectButton.disabled = false;
        console.error('Connect Error:', e);
      }
    }

    async function sendPayment(e) {
      e.preventDefault();
      if (!session) return statusEl.textContent = "Connect wallet first.";

      const recipient = document.getElementById('recipient').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const memo = document.getElementById('memo').value.trim();

      if (!recipient || isNaN(amount) || amount <= 0) {
        return statusEl.textContent = "Invalid recipient or amount.";
      }

      const quantity = `${amount.toFixed(4)} XPR`;
      statusEl.textContent = "Confirm in WebAuth...";

      try {
        const result = await session.transact({
          actions: [{
            account: 'eosio.token',
            name: 'transfer',
            authorization: [{ actor: session.auth.actor, permission: session.auth.permission }],
            data: { from: session.auth.actor, to: recipient, quantity, memo }
          }]
        }, { broadcast: true });

        statusEl.innerHTML = `
          <strong style="color:green">Success!</strong><br>
          <a href="https://explorer.xprnetwork.org/transaction/${result.processed.id}" target="_blank">
            View Tx: ${result.processed.id.slice(0, 12)}...
          </a>
        `;
      } catch (e) {
        statusEl.textContent = `Send failed: ${e.message || 'Unknown error'}`;
        console.error('Send Error:', e);
      }
    }

    connectButton.addEventListener('click', connectWallet);
    paymentForm.addEventListener('submit', sendPayment);
  </script>
</body>
</html>
