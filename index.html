<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPR SimplePay - Custom Payment</title>
    
    <!-- All CSS styles go in the <head> -->
    <style>
        :root {
            --brand-blue: #007aff;
            --brand-green: #34c759;
            --light-gray: #f4f4f9;
            --text-dark: #333;
            --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 20px;
            background: var(--light-gray); 
            color: var(--text-dark);
            display: flex;
            flex-direction: column; /* Changed to column to stack main content and footer */
            justify-content: flex-start;
            align-items: center; /* Center the container elements */
            min-height: 100vh;
        }
        .container {
            max-width: 420px;
            width: 100%;
            margin: 0 auto 40px; /* Added margin to the bottom of the container */
        }
        h1 {
            text-align: center;
            color: var(--text-dark);
            margin-bottom: 0.25rem; /* Reduced margin */
        }
        /* New style for the subtitle/merchant name */
        .merchant-subtitle {
            text-align: center;
            font-size: 0.85rem;
            color: #6c757d; /* Gray color */
            margin-bottom: 20px; /* Space before the card */
            display: block;
        }

        .payment-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        form div {
            margin-bottom: 16px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box; 
            font-size: 16px;
        }
        button { 
            padding: 14px 20px;
            font-size: 16px; 
            font-weight: 600;
            cursor: pointer; 
            border: none; 
            border-radius: 8px;
            width: 100%;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        button:active {
            transform: scale(0.98);
        }
        #connectButton { 
            background: var(--brand-blue); 
            color: white; 
            margin-bottom: 20px;
        }
        #connectButton:hover { background-color: #0056b3; }
        #sendButton { 
            background: var(--brand-green); 
            color: white; 
        }
        #sendButton:hover { background-color: #2a9d47; }
        #paymentForm { 
            display: none;
        }
        #userInfo { 
            text-align: center;
            font-weight: 600;
            color: var(--brand-blue);
            padding: 10px;
            background: #e6f2ff;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        #status { 
            margin-top: 20px;
            font-family: monospace;
            background: #eee;
            padding: 15px;
            border-radius: 8px;
            word-wrap: break-word;
            font-size: 14px;
        }
        #status a {
            color: var(--brand-blue);
        }
        /* New style for the footer */
        .footer {
            max-width: 420px;
            width: 100%;
            text-align: center;
            font-size: 0.75rem;
            color: #999;
            padding: 10px 0;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>

    <!-- All HTML content comes first -->
    <div class="container">
        <h1>XPR SimplePay</h1>
        <!-- ADDED SUBTITLE HERE -->
        <span class="merchant-subtitle">by UBITQUITY Merchant Solutions</span>

        <div class="payment-card">
            <button id="connectButton">Connect WebAuth Wallet</button>
            <div id="userInfo"></div>
            
            <form id="paymentForm">
                <div>
                    <label for="recipient">Recipient Account:</label>
                    <input type="text" id="recipient" value="nwosnack" placeholder="e.g., recipient.xpr">
                </div>
                <div>
                    <label for="amount">Amount (XPR):</label>
                    <input type="number" id="amount" step="0.0001" placeholder="e.g., 0.1">
                </div>
                <div>
                    <label for="memo">Memo (Optional):</label>
                    <input type="text" id="memo" placeholder="e.g., Invoice #123">
                </div>
                <button type="submit" id="sendButton">Send Payment</button>
            </form>
        </div>

        <div id="status">Connect your wallet to begin.</div>
    </div>
    
    <!-- ADDED FOOTER HERE -->
    <div class="footer">
        &copy; 2025 UBITQUITY, INC. | MIT License. v0.01 alpha
    </div>


    <!-- 
      START OF SCRIPT SECTION 
    -->

    <!-- 1. EXTERNAL SCRIPT: This loads the ProtonWebSDK library -->
    <script src="https://unpkg.com/@proton/web-sdk@4.4.0/dist/web-sdk.min.js" onload="initApp()"></script>

    <!-- 2. INTERNAL SCRIPT: This defines initApp() -->
    <script>
        // This function is now called explicitly by the script tag above
        function initApp() {
            // UPDATED APP NAME HERE
            const APP_NAME = 'XPR SimplePay';
            
            // Correct XPR Mainnet Chain ID
            const CHAIN_ID = '384da888112027f0321850a169f737c33e53b388aad48b5adace4bab97f437e0';
            
            // Public XPR Mainnet Endpoints
            const ENDPOINTS = ['https://xpr.cryptolions.io', 'https://xpr.eosphere.io'];

            // App state
            let session = null;
            let link = null;

            // Get all the HTML elements
            const connectButton = document.getElementById('connectButton');
            const paymentForm = document.getElementById('paymentForm');
            const userInfo = document.getElementById('userInfo');
            const statusEl = document.getElementById('status');
            
            // Initial check to ensure elements exist before listeners are added
            if (!connectButton || !paymentForm || !userInfo || !statusEl) {
                console.error("DOM Elements not found. Check HTML structure.");
                return;
            }

            // --- Function to Connect Wallet ---
            async function connectWallet() {
                try {
                    statusEl.textContent = "Connecting to wallet...";
                    
                    // The ProtonWebSDK function is now defined due to the onload handler
                    const { link: walletLink, session: walletSession } = await ProtonWebSDK({
                        linkOptions: { 
                            chainId: CHAIN_ID, 
                            endpoints: ENDPOINTS
                        },
                        transportOptions: { 
                            requestAccount: APP_NAME 
                        },
                        selectorOptions: { 
                            appName: APP_NAME
                        }
                    });

                    link = walletLink;
                    session = walletSession;
                    
                    // Update the UI
                    const actor = session.auth.actor;
                    userInfo.textContent = `Wallet Connected: ${actor}`;
                    userInfo.style.display = 'block';
                    connectButton.style.display = 'none';
                    paymentForm.style.display = 'block';
                    statusEl.textContent = 'Ready to send a transaction.';

                } catch (e) { 
                    statusEl.textContent = `Error connecting wallet: ${e.message}. Please check console for details.`;
                    console.error("Connect Error:", e);
                }
            }

            // --- Function to Send Payment ---
            async function sendPayment(event) {
                event.preventDefault(); 
                if (!session) {
                    statusEl.textContent = 'Please connect your wallet first.';
                    return;
                }

                // Get values from the form
                const recipient = document.getElementById('recipient').value;
                const amount = document.getElementById('amount').value;
                const memo = document.getElementById('memo').value; 

                // Simple validation
                if (!recipient || !amount || parseFloat(amount) <= 0) {
                    statusEl.textContent = 'Please fill in a valid Recipient and Amount.';
                    return;
                }

                // Format the quantity string: must be 4 decimal places and include the token symbol " XPR"
                const quantity = `${parseFloat(amount).toFixed(4)} XPR`;

                try {
                    statusEl.textContent = 'Sending transaction... Please check your wallet.';
                    const actor = session.auth.actor;
                    const permission = session.auth.permission;

                    // The Transaction Action Object
                    const actions = [
                        {
                            account: 'eosio.token', // The contract for the native XPR token
                            name: 'transfer',
                            authorization: [
                                {
                                    actor: actor,
                                    permission: permission,
                                }
                            ],
                            data: {
                                from: actor,
                                to: recipient,
                                quantity: quantity, // This is the user-defined amount
                                memo: memo,
                            },
                        }
                    ];

                    // Request the signature and broadcast the transaction
                    const result = await session.transact({ actions: actions }, {
                        broadcast: true
                    });

                    // Success! Show the link to the official explorer.
                    statusEl.innerHTML = `
                        <strong>Success!</strong><br>
                        Transaction ID: ${result.processed.id}<br>
                        <a href="https://explorer.xprnetwork.org/transaction/${result.processed.id}" target="_blank">View on Official XPR Explorer</a>
                    `;

                } catch (e) {
                    statusEl.textContent = `Error sending transaction: ${e.message}`;
                    console.error("Send Error:", e);
                }
            }

            // --- Attach functions to buttons ---
            connectButton.addEventListener('click', connectWallet);
            paymentForm.addEventListener('submit', sendPayment);
        
        } 
    </script>

</body>
</html>
